<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ambulance ETA Predictor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin=""/>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(120deg, #f0f4f8, #d9e2ec);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }
        h1 {
            color: #003366;
        }
        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
        }
        label {
            font-weight: bold;
            margin-top: 15px;
            display: block;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 5px;
        }
        button {
            margin-top: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background-color: #0056b3;
        }
        #results {
            margin-top: 30px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
        }
        ul {
            padding-left: 20px;
        }
        #map {
            height: 400px;
            margin-top: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-ambulance"></i> Ambulance ETA Predictor</h1>
        <p>Click to select: <strong>Start</strong>, <strong>End</strong>, then multiple <strong>Signals</strong> on the map.</p>

        <div id="map"></div>

        <label for="lat">Start Latitude:</label>
        <input type="text" id="lat" name="lat" readonly>

        <label for="lon">Start Longitude:</label>
        <input type="text" id="lon" name="lon" readonly>

        <label for="end_lat">End Latitude:</label>
        <input type="text" id="end_lat" name="end_lat" readonly>

        <label for="end_lon">End Longitude:</label>
        <input type="text" id="end_lon" name="end_lon" readonly>

        <button onclick="sendCoordinates()"><i class="fas fa-location-arrow"></i> Predict ETA</button>

        <div id="results"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <script>
        const map = L.map('map').setView([12.9716, 77.5946], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let startMarker = null;
        let endMarker = null;
        let signalMarkers = [];
        let routeLine = null;
        let clickCount = 0;

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            if (clickCount === 0) {
                document.getElementById("lat").value = lat.toFixed(6);
                document.getElementById("lon").value = lng.toFixed(6);
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker(e.latlng).addTo(map).bindPopup("Start Point").openPopup();
                clickCount++;
            } else if (clickCount === 1) {
                document.getElementById("end_lat").value = lat.toFixed(6);
                document.getElementById("end_lon").value = lng.toFixed(6);
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker(e.latlng).addTo(map).bindPopup("End Point").openPopup();
                clickCount++;
            } else {
                const marker = L.marker(e.latlng, { icon: L.divIcon({ className: 'custom-div-icon', html: `<div style='background:#ffcc00;border-radius:50%;width:16px;height:16px;'></div>` }) }).addTo(map);
                marker.bindPopup("Signal " + signalMarkers.length).openPopup();
                signalMarkers.push([lat, lng]);
            }
        });

        async function sendCoordinates() {
            const lat = document.getElementById("lat").value;
            const lon = document.getElementById("lon").value;
            const endLat = document.getElementById("end_lat").value;
            const endLon = document.getElementById("end_lon").value;

            const response = await fetch("/predict_eta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    start_lat: lat,
                    start_lon: lon,
                    end_lat: endLat,
                    end_lon: endLon,
                    signals: signalMarkers
                })
            });

            const data = await response.json();
            let resultDiv = document.getElementById("results");
            resultDiv.innerHTML = "<h3>ETA Predictions:</h3><ul>";
            data.forEach(item => {
                const key = item.signal || item.destination || "Unknown";
                resultDiv.innerHTML += `<li><strong>${key}</strong>: ${item.eta_minutes} minutes</li>`;
            });
            resultDiv.innerHTML += "</ul>";
        }
    </script>
</body>
</html>
